<div class="reserva-detail-container">
  <app-loading *ngIf="loading"></app-loading>

  <div class="header">
    <app-button
      label="‚Üê Voltar"
      variant="secondary"
      (clickEvent)="goBack()">
    </app-button>
    <h1>Detalhes da Reserva #{{ reserva?.id }}</h1>
  </div>

  <div class="error-message" *ngIf="error">
    {{ error }}
  </div>

  <div class="content" *ngIf="reserva && !loading">
    <!-- Informa√ß√µes da Reserva -->
    <div class="card reserva-info">
      <div class="card-header">
        <h2>üìã Informa√ß√µes da Reserva</h2>
        <span class="status-badge" [ngClass]="getStatusClass(reserva.status)">
          {{ getStatusIcon(reserva.status) }} {{ reserva.status }}
        </span>
      </div>

      <div class="info-grid">
        <div class="info-item">
          <label>Cliente</label>
          <p>{{ reserva.usuario.nome }}</p>
        </div>

        <div class="info-item">
          <label>Filial</label>
          <p>{{ reserva.espaco.filial.nome }}</p>
        </div>

        <div class="info-item">
          <label>Espa√ßo</label>
          <p>{{ reserva.espaco.nome }}</p>
        </div>

        <div class="info-item">
          <label>Data do Evento</label>
          <p [ngClass]="getDataClass(reserva.dataEvento)">
            {{ reserva.dataEvento | date: 'dd/MM/yyyy' }}
          </p>
        </div>

        <div class="info-item">
          <label>Capacidade do Espa√ßo</label>
          <p>{{ reserva.espaco.capacidade || 'N/A' }} pessoas</p>
        </div>

        <div class="info-item">
          <label>Contato do Cliente</label>
          <p>{{ reserva.usuario.telefone || reserva.usuario.email || 'N/A' }}</p>
        </div>

        <div class="info-item full-width" *ngIf="reserva.observacoes">
          <label>Observa√ß√µes</label>
          <p>{{ reserva.observacoes }}</p>
        </div>
      </div>

      <!-- A√ß√µes de Status -->
      <div class="status-actions" *ngIf="reserva.status !== StatusReserva.FINALIZADA && reserva.status !== StatusReserva.CANCELADA">
        <h3>Alterar Status</h3>
        <div class="button-group">
          <app-button
            *ngIf="reserva.status === StatusReserva.AGUARDANDO_SINAL"
            label="Confirmar"
            variant="success"
            (clickEvent)="updateStatus(StatusReserva.CONFIRMADA)">
          </app-button>

          <app-button
            *ngIf="reserva.status === StatusReserva.CONFIRMADA"
            label="Marcar como Quitada"
            variant="primary"
            (clickEvent)="updateStatus(StatusReserva.QUITADA)">
          </app-button>

          <app-button
            *ngIf="reserva.status === StatusReserva.QUITADA"
            label="Finalizar"
            variant="success"
            (clickEvent)="updateStatus(StatusReserva.FINALIZADA)">
          </app-button>

          <app-button
            label="Cancelar Reserva"
            variant="danger"
            (clickEvent)="updateStatus(StatusReserva.CANCELADA)">
          </app-button>
        </div>
      </div>
    </div>

    <!-- Resumo Financeiro -->
    <div class="card financial-summary">
      <div class="card-header">
        <h2>üí∞ Resumo Financeiro</h2>
      </div>

      <div class="financial-grid">
        <div class="financial-item">
          <label>Valor Total</label>
          <p class="valor-total">R$ {{ reserva.valorTotal.toFixed(2) }}</p>
        </div>

        <div class="financial-item">
          <label>Total Pago</label>
          <p class="valor-pago">R$ {{ getTotalPago().toFixed(2) }}</p>
        </div>

        <div class="financial-item">
          <label>Saldo Pendente</label>
          <p [ngClass]="isPagamentoQuitado() ? 'valor-quitado' : 'valor-pendente'">
            R$ {{ getSaldoPendente().toFixed(2) }}
          </p>
        </div>

        <div class="financial-item">
          <label>Status do Pagamento</label>
          <span class="payment-status" [ngClass]="isPagamentoQuitado() ? 'quitada' : 'pendente'">
            {{ isPagamentoQuitado() ? '‚úÖ Quitada' : '‚è≥ Pendente' }}
          </span>
        </div>
      </div>
    </div>

    <!-- Hist√≥rico de Pagamentos -->
    <div class="card pagamentos-section">
      <div class="card-header">
        <h2>üí≥ Hist√≥rico de Pagamentos</h2>
        <app-button
          *ngIf="!isPagamentoQuitado()"
          label="+ Registrar Pagamento"
          variant="primary"
          (clickEvent)="openPagamentoModal()">
        </app-button>
      </div>

      <app-loading *ngIf="loadingPagamentos"></app-loading>

      <div class="pagamentos-list" *ngIf="!loadingPagamentos">
        <div class="empty-state" *ngIf="pagamentos.length === 0">
          <p>Nenhum pagamento registrado ainda.</p>
        </div>

        <table class="pagamentos-table" *ngIf="pagamentos.length > 0">
          <thead>
            <tr>
              <th>Data</th>
              <th>Tipo</th>
              <th>Forma de Pagamento</th>
              <th>Valor</th>
              <th>C√≥d. Transa√ß√£o</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let pagamento of pagamentos">
              <td>{{ pagamento.dataPagamento | date: 'dd/MM/yyyy HH:mm' }}</td>
              <td>
                <span class="tipo-badge" [ngClass]="'tipo-' + pagamento.tipo.toLowerCase()">
                  {{ getTipoPagamentoIcon(pagamento.tipo) }} {{ pagamento.tipo }}
                </span>
              </td>
              <td>{{ pagamento.formaPagamento }}</td>
              <td class="valor-cell">R$ {{ pagamento.valor.toFixed(2) }}</td>
              <td>{{ pagamento.codigoTransacaoGateway || '-' }}</td>
              <td>
                <app-button
                  label="Excluir"
                  variant="danger"
                  size="small"
                  (clickEvent)="excluirPagamento(pagamento.id)">
                </app-button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal de Novo Pagamento -->
  <div class="modal-overlay" *ngIf="showPagamentoModal" (click)="closePagamentoModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>üí≥ Registrar Pagamento</h2>
        <button class="close-button" (click)="closePagamentoModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="info-box">
          <p>
            @if (pagamentos.length === 0) {
              <strong>Primeiro pagamento:</strong> Escolha entre pagar 50% agora (SINAL) ou o valor total (100%).
            } @else {
              <strong>Quita√ß√£o:</strong> Complete o pagamento com os 50% restantes.
            }
          </p>
        </div>

        <div class="form-group">
          <label for="tipo">Tipo de Pagamento *</label>
          <div class="tipo-pagamento-display">
            <input
              type="text"
              [value]="novoPagamento.tipo === TipoPagamento.SINAL ? 'üí∞ Sinal (50%)' : novoPagamento.tipo === TipoPagamento.TOTAL ? '‚úÖ Total (100%)' : 'üí≥ Quita√ß√£o (50%)'"
              readonly
              class="readonly-input">
            @if (permitirTrocarTipoPagamento()) {
              <button
                type="button"
                class="btn-toggle-tipo"
                (click)="alternarTipoPagamento()">
                Alternar para {{ novoPagamento.tipo === TipoPagamento.SINAL ? 'Total (100%)' : 'Sinal (50%)' }}
              </button>
            }
          </div>
        </div>

        <div class="form-group">
          <label for="valor">Valor *</label>
          <input
            type="text"
            id="valor"
            [value]="'R$ ' + novoPagamento.valor.toFixed(2)"
            readonly
            class="readonly-input">
          <small>Valor calculado automaticamente conforme o tipo de pagamento.</small>
        </div>

        <div class="form-group">
          <label for="formaPagamento">Forma de Pagamento *</label>
          <select id="formaPagamento" [(ngModel)]="novoPagamento.formaPagamento" required>
            <option value="">Selecione...</option>
            <option value="DINHEIRO">üíµ Dinheiro</option>
            <option value="PIX">üì± PIX</option>
            <option value="CREDITO">üí≥ Cart√£o de Cr√©dito</option>
            <option value="DEBITO">üí≥ Cart√£o de D√©bito</option>
            <option value="TRANSFERENCIA">üè¶ Transfer√™ncia Banc√°ria</option>
          </select>
        </div>

        <div class="form-group">
          <label for="codigoTransacao">C√≥digo de Transa√ß√£o</label>
          <input
            type="text"
            id="codigoTransacao"
            [(ngModel)]="novoPagamento.codigoTransacaoGateway"
            placeholder="Opcional">
          <small>Informe o c√≥digo caso tenha sido gerado pelo gateway de pagamento</small>
        </div>
      </div>

      <div class="modal-footer">
        <app-button
          label="Cancelar"
          variant="secondary"
          (clickEvent)="closePagamentoModal()">
        </app-button>
        <app-button
          label="Salvar Pagamento"
          variant="primary"
          (clickEvent)="salvarPagamento()">
        </app-button>
      </div>
    </div>
  </div>
</div>
