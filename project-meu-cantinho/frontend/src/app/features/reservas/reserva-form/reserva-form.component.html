<div class="reserva-form-container">
  <div class="loading" *ngIf="loading">Carregando...</div>

  <div class="header">
    <h1>{{ isCliente ? 'Nova Reserva' : 'Criar Reserva' }}</h1>
    <p *ngIf="isCliente">Reserve um espaÃ§o para seu evento</p>
    <p *ngIf="!isCliente">Crie uma reserva para um cliente</p>
  </div>

  <form class="reserva-form" (ngSubmit)="onSubmit()" *ngIf="!loading">
    <!-- SeleÃ§Ã£o de Cliente (apenas para Admin e FuncionÃ¡rio) -->
    <div class="form-section" *ngIf="!isCliente">
      <h2>ğŸ‘¤ Cliente</h2>
      <div class="form-group">
        <label for="cliente">Cliente *</label>
        <select
          id="cliente"
          [(ngModel)]="reserva.usuarioId"
          name="cliente"
          required>
          <option value="0">Selecione um cliente</option>
          <option *ngFor="let cliente of clientes" [value]="cliente.id">
            {{ cliente.nome }} - {{ cliente.email }}
          </option>
        </select>
        <small *ngIf="reserva.usuarioId">
          Cliente selecionado: {{ getClienteNome(reserva.usuarioId) }}
        </small>
      </div>
    </div>

    <!-- SeleÃ§Ã£o de Filial e EspaÃ§o -->
    <div class="form-section">
      <h2>ğŸ›ï¸ EspaÃ§o</h2>

      <!-- Filtro de filial removido: todos os espaÃ§os sÃ£o exibidos abaixo -->

      <div class="form-group">
        <label for="espaco">EspaÃ§o *</label>
        <select
          id="espaco"
          [(ngModel)]="reserva.espacoId"
          name="espaco"
          (change)="onEspacoChange()"
          required>
          <option value="0">Selecione um espaÃ§o</option>
          <option *ngFor="let espaco of espacos" [value]="espaco.id">
            {{ espaco.nome }} - {{ espaco.filial.nome }} (Cap: {{ espaco.capacidade }} pessoas)
          </option>
        </select>

        <!-- Info do EspaÃ§o Selecionado -->
        <div class="espaco-info" *ngIf="reserva.espacoId && getEspacoInfo(reserva.espacoId) as info">
          <div class="info-grid">
            <div class="info-item">
              <span class="icon">ğŸ›ï¸</span>
              <span class="label">EspaÃ§o:</span>
              <span class="value">{{ info.nome }}</span>
            </div>
            <div class="info-item">
              <span class="icon">ğŸ“</span>
              <span class="label">Filial:</span>
              <span class="value">{{ info.filial }}</span>
            </div>
            <div class="info-item">
              <span class="icon">ğŸ‘¥</span>
              <span class="label">Capacidade:</span>
              <span class="value">{{ info.capacidade }} pessoas</span>
            </div>
            <div class="info-item">
              <span class="icon">ğŸ’°</span>
              <span class="label">Valor DiÃ¡ria:</span>
              <span class="value">R$ {{ info.preco | number:'1.2-2' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Data e Valor -->
    <div class="form-section">
      <h2>ğŸ“… Data e Valor</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="dataEvento">Data do Evento *</label>
          <input
            type="date"
            id="dataEvento"
            [(ngModel)]="reserva.dataEvento"
            name="dataEvento"
            [min]="getMinDate()"
            required>
        </div>

        <div class="form-group">
          <label>Valor Total (R$)</label>
          <div class="valor-display">
            <span class="valor-label">R$</span>
            <span class="valor-value">{{ reserva.valorTotal | number:'1.2-2' }}</span>
          </div>
          <small *ngIf="reserva.espacoId">Valor calculado automaticamente com base na diÃ¡ria do espaÃ§o</small>
        </div>
      </div>
    </div>

    <!-- ObservaÃ§Ãµes -->
    <div class="form-section">
      <h2>ğŸ“ ObservaÃ§Ãµes</h2>
      <div class="form-group">
        <label for="observacoes">ObservaÃ§Ãµes Adicionais</label>
        <textarea
          id="observacoes"
          [(ngModel)]="reserva.observacoes"
          name="observacoes"
          rows="4"
          placeholder="InformaÃ§Ãµes adicionais sobre a reserva..."></textarea>
      </div>
    </div>

    <!-- Pagamento -->
    <div class="form-section" *ngIf="reserva.espacoId && reserva.valorTotal > 0">
      <h2>ğŸ’³ Pagamento</h2>

      <div class="form-group">
        <label>Tipo de Pagamento *</label>
        <div class="radio-group">
          <label class="radio-option">
            <input
              type="radio"
              name="tipoPagamento"
              [value]="TipoPagamento.SINAL"
              [(ngModel)]="tipoPagamento">
            <span>Sinal (50%)</span>
            <span class="radio-value">R$ {{ reserva.valorTotal * 0.5 | number:'1.2-2' }}</span>
          </label>
          <label class="radio-option">
            <input
              type="radio"
              name="tipoPagamento"
              [value]="TipoPagamento.TOTAL"
              [(ngModel)]="tipoPagamento">
            <span>Pagamento Total (100%)</span>
            <span class="radio-value">R$ {{ reserva.valorTotal | number:'1.2-2' }}</span>
          </label>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="formaPagamento">Forma de Pagamento *</label>
          <select
            id="formaPagamento"
            [(ngModel)]="formaPagamento"
            name="formaPagamento"
            required>
            <option value="">Selecione...</option>
            <option value="Dinheiro">Dinheiro</option>
            <option value="CartÃ£o de CrÃ©dito">CartÃ£o de CrÃ©dito</option>
            <option value="CartÃ£o de DÃ©bito">CartÃ£o de DÃ©bito</option>
            <option value="PIX">PIX</option>
            <option value="TransferÃªncia">TransferÃªncia BancÃ¡ria</option>
          </select>
        </div>

        <div class="form-group">
          <label for="codigoTransacao">CÃ³digo da TransaÃ§Ã£o (opcional)</label>
          <input
            type="text"
            id="codigoTransacao"
            [(ngModel)]="codigoTransacao"
            name="codigoTransacao"
            placeholder="Ex: cÃ³digo do PIX, autorizaÃ§Ã£o do cartÃ£o">
        </div>
      </div>

      <div class="pagamento-info">
        <div class="info-item">
          <span class="icon">ğŸ’µ</span>
          <span class="label">Valor a pagar agora:</span>
          <span class="value highlight">R$ {{ getValorPagamento() | number:'1.2-2' }}</span>
        </div>
        <div class="info-item" *ngIf="tipoPagamento === TipoPagamento.SINAL">
          <span class="icon">âš ï¸</span>
          <span class="label">Saldo restante:</span>
          <span class="value">R$ {{ reserva.valorTotal * 0.5 | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>

    <!-- Resumo -->
    <div class="form-section resumo-section" *ngIf="reserva.espacoId && reserva.dataEvento">
      <h2>ğŸ“‹ Resumo da Reserva</h2>
      <div class="resumo-content">
        <div class="resumo-item">
          <span class="label">Cliente:</span>
          <span class="value">{{ isCliente ? 'VocÃª' : getClienteNome(reserva.usuarioId) }}</span>
        </div>
        <div class="resumo-item" *ngIf="getEspacoInfo(reserva.espacoId) as info">
          <span class="label">EspaÃ§o:</span>
          <span class="value">{{ info.nome }} ({{ info.filial }})</span>
        </div>
        <div class="resumo-item">
          <span class="label">Data do Evento:</span>
          <span class="value">{{ reserva.dataEvento | date:'dd/MM/yyyy' }}</span>
        </div>
        <div class="resumo-item total">
          <span class="label">Valor Total:</span>
          <span class="value">R$ {{ reserva.valorTotal | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>

    <!-- AÃ§Ãµes -->
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="cancel()">
        Cancelar
      </button>
      <button type="submit" class="btn btn-primary" [disabled]="loading">
        Criar Reserva
      </button>
    </div>
  </form>
</div>
